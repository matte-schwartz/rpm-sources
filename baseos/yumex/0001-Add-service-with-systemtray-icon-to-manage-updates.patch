From d8abdc5111c01329c930dd6ac781889ee2fbf019 Mon Sep 17 00:00:00 2001
From: GloriousEggroll <gloriouseggroll@gmail.com>
Date: Wed, 12 Jun 2024 02:44:54 -0600
Subject: [PATCH] Add service with systemtray icon to manage updates

- this adds a standalone user service yumex-updater-systray.service  which monitors system and flatpak updates, and updates hourly
- the service has a dbus access point at com.yumex.UpdateService that can be used to call RefreshUpdates()
- the dbus util added to yumex has a function sync_updates that can be called from anywhere within yumex to call RefreshUpdates()
- the dbus util will also check if the service is running before attempting to issue an update refresh to the service.
- when updates are available, an icon will appear in the system tray. Hovering the icon will display a count for both system and flatpak updates available. Right clicking the icon gives a menu for the user to choose to either refresh the updates or open yumex.
- a config file is added to ~/.config/yumex/
- also fixes some spelling errors in various places
---
 .../apps/yumex-system-software-update.svg     |  12 ++
 data/icons/meson.build                        |   6 +-
 meson.build                                   |   4 +-
 po/ca.po                                      |   6 +-
 po/da.po                                      |   8 +-
 po/it.po                                      |   6 +-
 po/it_IT.po                                   |   6 +-
 po/tr_TR.po                                   |   8 +-
 po/yumex.pot                                  |   2 +-
 yumex.spec                                    |  37 ++++-
 yumex/backend/dnf/dnf4.py                     |   2 +
 yumex/backend/dnf/dnf5.py                     |   2 +
 yumex/meson.build                             |  36 ++++-
 yumex/service/50-yumex-updater-systray.preset |   1 +
 yumex/service/__init__.py                     |  14 ++
 yumex/service/dnf4.py                         |  44 ++++++
 yumex/service/dnf5.py                         |  58 +++++++
 yumex/service/yumex-service.conf              |   4 +
 yumex/service/yumex-updater-systray.service   |  14 ++
 yumex/service/yumex_updater_systray.py        | 145 ++++++++++++++++++
 yumex/ui/flatpak_result.py                    |   2 +-
 yumex/ui/flatpak_view.py                      |  18 ++-
 yumex/ui/window.py                            |   4 +-
 yumex/utils/dbus.py                           |  39 +++++
 24 files changed, 438 insertions(+), 40 deletions(-)
 create mode 100644 data/icons/hicolor/scalable/apps/yumex-system-software-update.svg
 create mode 100644 yumex/service/50-yumex-updater-systray.preset
 create mode 100644 yumex/service/__init__.py
 create mode 100644 yumex/service/dnf4.py
 create mode 100644 yumex/service/dnf5.py
 create mode 100644 yumex/service/yumex-service.conf
 create mode 100644 yumex/service/yumex-updater-systray.service
 create mode 100755 yumex/service/yumex_updater_systray.py
 create mode 100644 yumex/utils/dbus.py

diff --git a/data/icons/hicolor/scalable/apps/yumex-system-software-update.svg b/data/icons/hicolor/scalable/apps/yumex-system-software-update.svg
new file mode 100644
index 0000000..1c97048
--- /dev/null
+++ b/data/icons/hicolor/scalable/apps/yumex-system-software-update.svg
@@ -0,0 +1,12 @@
+<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" version="1">
+ <path style="opacity:0.2;fill-rule:evenodd" d="m 30.855237,59.999437 c 1.121245,0.007 2.252143,-0.05118 3.379848,-0.1797 4.47527,-0.509994 8.834439,-2.091515 12.664623,-4.699594 5.640792,-3.840972 9.469962,-9.585324 11.166826,-16.005182 1.321819,-0.601829 2.512299,-1.514389 3.454346,-2.765847 1.87007,-2.484285 2.071677,-6.942599 0,-9.696084 a 6.0231602,6.0010788 0 0 0 0,-0.004 l -1.882049,-2.500199 a 6.0231602,6.0010788 0 0 0 -0.004,-0.004 L 57.74886,21.64463 c -2.073589,-2.7492 -5.012076,-3.644637 -7.637905,-3.644637 -2.625829,0 -5.564316,0.895437 -7.637983,3.644823 l -1.885971,2.500199 a 6.0231602,6.0010788 0 0 0 -0.004,0.004 l -1.882048,2.500199 a 6.0231602,6.0010788 0 0 0 0,0.004 c -2.071677,2.753485 -1.870071,7.211799 0,9.696084 0.258178,0.342978 0.65206,0.468678 0.944944,0.761782 -0.733782,1.229748 -1.718055,2.313483 -2.944623,3.148687 -2.746979,1.870495 -6.205823,2.263851 -9.3083,1.058678 l 0.0941,0.03516 c -2.345611,-0.956015 -5.27629,-0.876265 -7.461543,0.218768 -2.185253,1.095032 -3.610381,2.888499 -4.375766,4.844136 -0.76538,1.955636 -0.934994,4.236293 -0.07058,6.516144 0.859369,2.266127 2.946486,4.281432 5.305112,5.168194 3.225648,1.245451 6.606079,1.877381 9.97094,1.898589 z"/>
+ <path style="fill:#ff9932;fill-rule:evenodd" d="m 30.855237,58.999428 c 1.121245,0.007 2.252143,-0.05118 3.379848,-0.1797 4.47527,-0.509994 8.834439,-2.091515 12.664623,-4.699594 5.640792,-3.840971 9.469962,-9.585324 11.166826,-16.005182 1.321819,-0.601828 2.512299,-1.514389 3.454346,-2.765847 1.87007,-2.484285 2.071677,-6.942599 0,-9.696084 a 6.0231602,6.0010788 0 0 0 0,-0.004 l -1.882049,-2.500199 a 6.0231602,6.0010788 0 0 0 -0.004,-0.004 L 57.74886,20.644621 c -2.073589,-2.749201 -5.012076,-3.644638 -7.637905,-3.644638 -2.625829,0 -5.564316,0.895437 -7.637983,3.644824 l -1.885971,2.500199 a 6.0231602,6.0010788 0 0 0 -0.004,0.004 l -1.882048,2.500199 a 6.0231602,6.0010788 0 0 0 0,0.004 c -2.071677,2.753485 -1.870071,7.211799 0,9.696084 0.258178,0.342978 0.65206,0.468678 0.944944,0.761782 -0.733782,1.229749 -1.718055,2.313483 -2.944623,3.148687 -2.746979,1.870495 -6.205823,2.263851 -9.3083,1.058679 l 0.0941,0.03516 c -2.345611,-0.956015 -5.27629,-0.876265 -7.461543,0.218768 -2.185253,1.095032 -3.610381,2.888499 -4.375766,4.844136 -0.76538,1.955637 -0.934994,4.236293 -0.07058,6.516144 0.859369,2.266127 2.946486,4.281432 5.305112,5.168194 3.225648,1.245451 6.606079,1.877381 9.97094,1.898589 z"/>
+ <path style="opacity:0.2;fill-rule:evenodd" d="M 33.144531 6 C 32.023287 5.99294 30.893329 6.0511751 29.765625 6.1796875 C 25.290355 6.6896817 20.929792 8.2708284 17.099609 10.878906 C 11.458817 14.719877 7.6304594 20.464908 5.9335938 26.884766 C 4.6117754 27.486594 3.4205618 28.398933 2.4785156 29.650391 C 0.60844487 32.134676 0.40683879 36.594171 2.4785156 39.347656 A 6.0231602 6.0010788 0 0 0 2.4785156 39.351562 L 4.3613281 41.851562 A 6.0231602 6.0010788 0 0 0 4.3652344 41.855469 L 6.2519531 44.355469 C 8.3256213 47.104668 11.262842 48 13.888672 48 C 16.514501 48 19.453677 47.104856 21.527344 44.355469 L 23.412109 41.855469 A 6.0231602 6.0010788 0 0 0 23.417969 41.851562 L 25.298828 39.351562 A 6.0231602 6.0010788 0 0 0 25.298828 39.347656 C 27.370505 36.594171 27.168899 32.134676 25.298828 29.650391 C 25.04065 29.307413 24.6464 29.181776 24.353516 28.888672 C 25.087298 27.658923 26.07226 26.575439 27.298828 25.740234 C 30.045807 23.86974 33.504945 23.476469 36.607422 24.681641 L 36.513672 24.646484 C 37.294935 24.964908 38.141993 25.156725 39.003906 25.246094 L 40.582031 23.148438 L 40.587891 23.144531 L 42.472656 20.644531 C 44.245618 18.293836 46.649759 17.303724 48.951172 17.064453 C 49.076111 15.776964 48.93382 14.421789 48.419922 13.066406 C 47.560554 10.800282 45.473861 8.7851997 43.115234 7.8984375 C 39.889587 6.6529864 36.509393 6.0212084 33.144531 6 z"/>
+ <path style="fill:#ffda43;fill-rule:evenodd" d="m 33.144762,5.0005502 c -1.121244,-0.00706 -2.252143,0.05119 -3.379847,0.1797024 -4.47527,0.5099942 -8.83444,2.0915155 -12.664623,4.6995935 C 11.4595,13.720817 7.630331,19.465171 5.9334653,25.885029 c -1.3218184,0.601828 -2.5122988,1.514389 -3.454345,2.765847 -1.87007076,2.484285 -2.07167684,6.942599 0,9.696084 a 6.0231602,6.0010788 0 0 0 0,0.004 l 1.8820493,2.500199 a 6.0231602,6.0010788 0 0 0 0.00392,0.004 l 1.8859706,2.500201 c 2.0736682,2.749199 5.0121548,3.644635 7.6379848,3.644635 2.625829,0 5.564316,-0.895436 7.637983,-3.644823 l 1.88597,-2.500199 a 6.0231602,6.0010788 0 0 0 0.004,-0.004 l 1.882049,-2.500199 a 6.0231602,6.0010788 0 0 0 0,-0.004 c 2.071677,-2.753485 1.870071,-7.211799 0,-9.696084 -0.258178,-0.342978 -0.65206,-0.468678 -0.944944,-0.761782 0.733782,-1.229749 1.718055,-2.313483 2.944623,-3.148688 2.746979,-1.870494 6.205823,-2.26385 9.3083,-1.058678 l -0.0941,-0.03516 c 2.345611,0.956014 5.27629,0.876264 7.461543,-0.218768 2.185253,-1.095032 3.610381,-2.8885 4.375765,-4.844137 0.765381,-1.955636 0.934995,-4.236292 0.07058,-6.516145 C 47.561446,9.8012075 45.474329,7.7859015 43.115702,6.8991393 39.890055,5.6536882 36.509624,5.0217586 33.144762,5.0005502 Z"/>
+ <path style="opacity:0.2;fill:#ffffff;fill-rule:evenodd" d="M 33.144531 5 C 32.023287 4.99294 30.893329 5.0511751 29.765625 5.1796875 C 25.290355 5.6896817 20.929792 7.2708283 17.099609 9.8789062 C 11.458817 13.719877 7.6304595 19.464908 5.9335938 25.884766 C 4.6117754 26.486594 3.4205618 27.398933 2.4785156 28.650391 C 1.4384686 30.032035 0.93902516 32.024179 1.0351562 33.994141 C 1.1279663 32.368205 1.615393 30.797001 2.4785156 29.650391 C 3.4205618 28.398933 4.6117754 27.486594 5.9335938 26.884766 C 7.6304594 20.464908 11.458817 14.719877 17.099609 10.878906 C 20.929792 8.2708284 25.290355 6.6896817 29.765625 6.1796875 C 30.893329 6.0511751 32.023287 5.99294 33.144531 6 C 36.509393 6.0212084 39.889587 6.6529864 43.115234 7.8984375 C 45.473861 8.7851997 47.560554 10.800282 48.419922 13.066406 C 48.749149 13.934726 48.92702 14.803745 48.980469 15.654297 C 49.039639 14.490607 48.879537 13.27862 48.419922 12.066406 C 47.560554 9.8002818 45.473861 7.7851997 43.115234 6.8984375 C 39.889587 5.6529864 36.509393 5.0212084 33.144531 5 z M 24.800781 28.222656 C 24.646363 28.441418 24.490522 28.659062 24.353516 28.888672 C 24.6464 29.181776 25.04065 29.307413 25.298828 29.650391 C 26.162316 30.797486 26.651642 32.369421 26.744141 33.996094 C 26.840699 32.025517 26.339208 30.032477 25.298828 28.650391 C 25.159356 28.465108 24.982143 28.341767 24.800781 28.222656 z"/>
+ <path style="opacity:0.2;fill-rule:evenodd" d="m 33.144544,12.003901 c -0.88366,-0.0056 -1.76806,0.04038 -2.644533,0.140625 -3.505889,0.400995 -6.91598,1.642416 -9.914066,3.691408 -5.440817,3.718435 -8.87069,9.668679 -9.464848,16.164068 l -0.875,0 a 3.2489855,2.500465 0 0 0 -2.8125011,3.750001 l 1.8750007,2.500001 1.8789074,2.500001 a 3.2489855,2.500465 0 0 0 5.625002,0 l 1.878907,-2.500001 1.875,-2.500001 a 3.2489855,2.500465 0 0 0 -2.812501,-3.750001 l -0.625,0 c 0.567324,-4.514418 3.033985,-8.60722 6.843753,-11.210941 4.365573,-2.983578 9.913328,-3.616084 14.83985,-1.695313 a 3.0003012,3.0003012 0 1 0 2.179688,-5.589846 c -2.537489,-0.989326 -5.19668,-1.483231 -7.847659,-1.500001 z"/>
+ <path style="fill:#3f3f3f;fill-rule:evenodd" d="m 33.144544,11.003887 c -0.88366,-0.0056 -1.76806,0.04038 -2.644533,0.140625 -3.505889,0.400996 -6.91598,1.642417 -9.914066,3.691408 -5.440817,3.718435 -8.87069,9.66868 -9.464848,16.164069 l -0.875,0 A 3.2489855,2.500465 0 0 0 7.4335959,34.74999 l 1.8750007,2.500001 1.8789074,2.500001 a 3.2489855,2.500465 0 0 0 5.625002,0 l 1.878907,-2.500001 1.875,-2.500001 a 3.2489855,2.500465 0 0 0 -2.812501,-3.750001 l -0.625,0 c 0.567324,-4.514418 3.033985,-8.607219 6.843753,-11.210942 4.365573,-2.983578 9.913328,-3.616084 14.83985,-1.695313 a 3.0003012,3.0003012 0 1 0 2.179688,-5.589846 c -2.537489,-0.989326 -5.19668,-1.483231 -7.847659,-1.500001 z"/>
+ <path style="fill:#ff9932;fill-rule:evenodd" d="m 61.52088,25.653021 0,-0.004 -1.882049,-2.500199 -0.004,-0.004 -1.885971,-2.500201 c -2.073589,-2.749201 -5.012076,-3.644638 -7.637905,-3.644638 -2.625829,0 -5.564316,0.895437 -7.637983,3.644824 l -1.885971,2.500199 -0.004,0.004 -1.882048,2.500199 0,0.004 z"/>
+ <path style="opacity:0.2;fill-rule:evenodd" d="m 30.855455,53.996101 c 0.883661,0.0056 1.768061,-0.04038 2.644533,-0.14062 3.50589,-0.400995 6.915981,-1.642417 9.914066,-3.691408 5.440819,-3.718441 8.87069,-9.668686 9.464848,-16.164074 l 0.875001,0 a 3.2489855,2.500465 0 0 0 2.812501,-3.750002 l -1.875001,-2.500001 -1.878907,-2.500001 a 3.2489855,2.500465 0 0 0 -5.625002,0 l -1.878907,2.500001 -1.875001,2.500001 a 3.2489855,2.500465 0 0 0 2.812502,3.750002 l 0.625,0 c -0.567324,4.514417 -3.033985,8.607219 -6.843753,11.210942 -4.365574,2.983577 -9.913328,3.616084 -14.83985,1.695313 A 3.0003012,3.0003012 0 1 0 23.007796,52.4961 c 2.537489,0.989326 5.19668,1.483231 7.847659,1.500001 z"/>
+ <path style="fill:#3f3f3f;fill-rule:evenodd" d="m 30.855455,52.996092 c 0.883661,0.0056 1.768061,-0.04038 2.644533,-0.14062 3.50589,-0.400994 6.915981,-1.642417 9.914066,-3.691408 5.440819,-3.718441 8.87069,-9.668686 9.464848,-16.164074 l 0.875001,0 a 3.2489855,2.500465 0 0 0 2.812501,-3.750002 l -1.875001,-2.500001 -1.878907,-2.500001 a 3.2489855,2.500465 0 0 0 -5.625002,0 l -1.878907,2.500001 -1.875001,2.500001 a 3.2489855,2.500465 0 0 0 2.812502,3.750002 l 0.625,0 c -0.567324,4.514418 -3.033985,8.607219 -6.843753,11.210942 -4.365574,2.983577 -9.913328,3.616084 -14.83985,1.695313 a 3.0003012,3.0003012 0 1 0 -2.179689,5.589846 c 2.537489,0.989327 5.19668,1.483231 7.847659,1.500001 z"/>
+</svg>
diff --git a/data/icons/meson.build b/data/icons/meson.build
index f539718..01d7bc1 100644
--- a/data/icons/meson.build
+++ b/data/icons/meson.build
@@ -2,4 +2,8 @@ scalable_dir = join_paths('hicolor', 'scalable', 'apps')
 install_data(
   join_paths(scalable_dir, ('@0@.svg').format(APPLICATION_ID)),
   install_dir: join_paths(get_option('datadir'), 'icons', scalable_dir)
-)
\ No newline at end of file
+)
+install_data(
+  join_paths(scalable_dir, 'yumex-system-software-update.svg'),
+  install_dir: join_paths(get_option('datadir'), 'icons', scalable_dir)
+)
diff --git a/meson.build b/meson.build
index cfff121..af21d57 100644
--- a/meson.build
+++ b/meson.build
@@ -1,7 +1,7 @@
 project(
     'yumex',
     version: '5.0.0',
-    meson_version: '>= 0.59.0',
+    meson_version: '>= 0.61.0',
 )
 
 APPLICATION_ID = 'dk.yumex.Yumex'
@@ -88,4 +88,4 @@ gnome.post_install(
     glib_compile_schemas: true,
     gtk_update_icon_cache: true,
     update_desktop_database: true,
-)
\ No newline at end of file
+)
diff --git a/po/ca.po b/po/ca.po
index 114b785..b1df9f6 100644
--- a/po/ca.po
+++ b/po/ca.po
@@ -30,7 +30,7 @@ msgstr "S'instal·la"
 msgid "Uninstalling"
 msgstr "Es desinstal·la"
 
-#: yumex/backend/flatpak/transaction.py:70
+#: yumex/backend/flatpak/transaction.py:70 yumex/ui/flatpak_result.py:40
 msgid "Updating"
 msgstr "S'actualitza"
 
@@ -259,10 +259,6 @@ msgstr "A la cua per a la instal·lació"
 msgid "Queued for updating"
 msgstr "A la cua per a l'actualització"
 
-#: yumex/ui/flatpak_result.py:40
-msgid "Updateing"
-msgstr "S'actualitza"
-
 #: yumex/main.py:166
 msgid ""
 "\n"
diff --git a/po/da.po b/po/da.po
index 902dba5..8d63699 100644
--- a/po/da.po
+++ b/po/da.po
@@ -56,8 +56,8 @@ msgstr ""
 msgid "Uninstalling"
 msgstr ""
 
-#: yumex/ui/flatpak_result.py:37
-msgid "Updateing"
+#: yumex/ui/flatpak_result.py:37 yumex/backend/flatpak/transaction.py:65
+msgid "Updating"
 msgstr ""
 
 #: yumex/ui/transaction_result.py:65
@@ -135,10 +135,6 @@ msgstr ""
 msgid "Downloading repository information for {name}"
 msgstr "indlæser kilde information for {name}"
 
-#: yumex/backend/flatpak/transaction.py:65
-msgid "Updating"
-msgstr ""
-
 #: yumex/backend/daemon.py:80
 msgid "Applying Transaction"
 msgstr "Udfører Transaktion"
diff --git a/po/it.po b/po/it.po
index a21625b..99d7216 100644
--- a/po/it.po
+++ b/po/it.po
@@ -30,7 +30,7 @@ msgstr "Installando"
 msgid "Uninstalling"
 msgstr "Disinstallando"
 
-#: yumex/backend/flatpak/transaction.py:70
+#: yumex/backend/flatpak/transaction.py:70 yumex/ui/flatpak_result.py:38
 msgid "Updating"
 msgstr "Aggiornando"
 
@@ -189,10 +189,6 @@ msgstr "In coda per l'installazione"
 msgid "Queued for updating"
 msgstr "In coda per l'aggiornamento"
 
-#: yumex/ui/flatpak_result.py:38
-msgid "Updateing"
-msgstr "Aggiornando"
-
 #: yumex/ui/package_view.py:96
 msgid "Loading Packages"
 msgstr "Caricamento dei Pacchetti"
diff --git a/po/it_IT.po b/po/it_IT.po
index 7ea3b86..a7deb30 100644
--- a/po/it_IT.po
+++ b/po/it_IT.po
@@ -30,7 +30,7 @@ msgstr "Installando"
 msgid "Uninstalling"
 msgstr "Disinstallando"
 
-#: yumex/backend/flatpak/transaction.py:70
+#: yumex/backend/flatpak/transaction.py:70 yumex/ui/flatpak_result.py:38
 msgid "Updating"
 msgstr "Aggiornando"
 
@@ -189,10 +189,6 @@ msgstr "In coda per l'installazione"
 msgid "Queued for updating"
 msgstr "In coda per l'aggiornamento"
 
-#: yumex/ui/flatpak_result.py:38
-msgid "Updateing"
-msgstr "Aggiornando"
-
 #: yumex/ui/package_view.py:96
 msgid "Loading Packages"
 msgstr "Caricamento dei Pacchetti"
diff --git a/po/tr_TR.po b/po/tr_TR.po
index 5476a1c..dd88189 100644
--- a/po/tr_TR.po
+++ b/po/tr_TR.po
@@ -30,9 +30,9 @@ msgstr "Kuruluyor"
 msgid "Uninstalling"
 msgstr ""
 
-#: yumex/backend/flatpak/transaction.py:70
+#: yumex/backend/flatpak/transaction.py:70 yumex/ui/flatpak_result.py:40
 msgid "Updating"
-msgstr ""
+msgstr "Güncelleniyor"
 
 #: yumex/backend/flatpak/transaction.py:180
 msgid "flatpak transaction failed"
@@ -259,10 +259,6 @@ msgstr "Kurulum için sıraya alındı"
 msgid "Queued for updating"
 msgstr "Güncellenmek üzere sıraya alındı"
 
-#: yumex/ui/flatpak_result.py:40
-msgid "Updateing"
-msgstr "Güncelleniyor"
-
 #: yumex/main.py:166
 msgid ""
 "\n"
diff --git a/po/yumex.pot b/po/yumex.pot
index 386e107..ef13743 100644
--- a/po/yumex.pot
+++ b/po/yumex.pot
@@ -186,7 +186,7 @@ msgid "Queued for updating"
 msgstr ""
 
 #: yumex/ui/flatpak_result.py:38
-msgid "Updateing"
+msgid "Updating"
 msgstr ""
 
 #: yumex/ui/package_info.py:26 yumex/ui/package_info.py:33
diff --git a/yumex.spec b/yumex.spec
index cd91243..fc21c82 100644
--- a/yumex.spec
+++ b/yumex.spec
@@ -24,12 +24,13 @@ BuildRequires: pkgconfig(glib-2.0)
 BuildRequires: pkgconfig(gtk4)
 BuildRequires: pkgconfig(libadwaita-1)
 BuildRequires: pkgconfig(pygobject-3.0)
-
+BuildRequires: systemd-rpm-macros
 
 Requires: python3-gobject
 Requires: libadwaita
 Requires: gtk4
 Requires: flatpak-libs
+Requires: python3-dbus
 
 # dnf4 requirements
 %if "%{dnf_backend}" == "DNF4"
@@ -92,6 +93,40 @@ update-desktop-database %{_datadir}/applications &> /dev/null || :
 %{_datadir}/icons/hicolor/
 %{_metainfodir}/%{app_id}.metainfo.xml
 %{_datadir}/glib-2.0/schemas/%{app_id}.gschema.xml
+%{_userunitdir}/*.service
+%{_prefix}/lib/systemd/user-preset/*.preset
+%{_datadir}/yumex/yumex-service.conf
+%{_bindir}/yumex_updater_systray
+
+%post
+glib-compile-schemas /usr/share/glib-2.0/schemas/
+%systemd_user_post yumex-updater-systray.service
+
+%posttrans
+%systemd_user_post yumex-updater-systray.service
+
+# Iterate over all user sessions
+for session in $(loginctl list-sessions --no-legend | awk '{print $1}'); do
+    uid=$(loginctl show-session $session -p User --value)
+    user=$(getent passwd $uid | cut -d: -f1)
+
+    # Debug statement to verify user and UID
+    echo "Applying preset and restarting service for user $user with UID $uid"
+
+    # Set environment variables for the user session
+    XDG_RUNTIME_DIR="/run/user/$uid"
+    DBUS_SESSION_BUS_ADDRESS="unix:path=$XDG_RUNTIME_DIR/bus"
+
+    # Apply the preset for the user session
+    su - $user -c "XDG_RUNTIME_DIR=$XDG_RUNTIME_DIR DBUS_SESSION_BUS_ADDRESS=$DBUS_SESSION_BUS_ADDRESS systemctl --user preset yumex-updater-systray.service" || echo "Failed to apply preset for user $user"
+
+    # Reload the user daemon and restart the service
+    su - $user -c "XDG_RUNTIME_DIR=$XDG_RUNTIME_DIR DBUS_SESSION_BUS_ADDRESS=$DBUS_SESSION_BUS_ADDRESS systemctl --user daemon-reload" || echo "Failed to perform daemon-reload for user $user"
+    su - $user -c "XDG_RUNTIME_DIR=$XDG_RUNTIME_DIR DBUS_SESSION_BUS_ADDRESS=$DBUS_SESSION_BUS_ADDRESS systemctl --user restart yumex-updater-systray.service" || echo "Failed to restart service for user $user"
+done
+
+%preun
+%systemd_user_preun yumex-updater-systray.service
 
 %changelog
 
diff --git a/yumex/backend/dnf/dnf4.py b/yumex/backend/dnf/dnf4.py
index e63ffba..85f7beb 100644
--- a/yumex/backend/dnf/dnf4.py
+++ b/yumex/backend/dnf/dnf4.py
@@ -27,6 +27,7 @@ import shutil
 import glob
 import os
 
+from yumex.utils.dbus import sync_updates
 from yumex.utils import log
 from yumex.utils.enums import (
     PackageAction,
@@ -504,6 +505,7 @@ class Backend(DnfBase):
                 return self.packages.installed
             case PackageFilter.UPDATES:
                 self.dnf_temp_cleanup()
+                sync_updates()
                 return self.get_packages_with_lowest_priority(self.packages.updates)
             case other:
                 raise ValueError(f"{other} is not an legal package filter")
diff --git a/yumex/backend/dnf/dnf5.py b/yumex/backend/dnf/dnf5.py
index c06fbca..0222401 100644
--- a/yumex/backend/dnf/dnf5.py
+++ b/yumex/backend/dnf/dnf5.py
@@ -32,6 +32,7 @@ from yumex.backend.dnf import YumexPackage
 from yumex.backend.interface import Presenter
 from yumex.utils.enums import SearchField, PackageState, InfoType, PackageFilter
 
+from yumex.utils.dbus import sync_updates
 from yumex.utils import log
 
 
@@ -246,6 +247,7 @@ class Backend(dnf.Base):
                 return self._get_yumex_packages(self.installed)
             case PackageFilter.UPDATES:
                 self.dnf_temp_cleanup()
+                sync_updates()
                 packages = self._get_yumex_packages(self.updates, state=PackageState.UPDATE)
                 return self.get_packages_with_lowest_priority(packages)
             case other:
diff --git a/yumex/meson.build b/yumex/meson.build
index ace11e7..396900d 100644
--- a/yumex/meson.build
+++ b/yumex/meson.build
@@ -89,5 +89,39 @@ yumex_utils_modules = [
   'utils/enums.py',
   'utils/storage.py',
   'utils/types.py',
+  'utils/dbus.py',
 ]
-PY_INSTALLDIR.install_sources(yumex_utils_modules, subdir: 'yumex/utils')
\ No newline at end of file
+PY_INSTALLDIR.install_sources(yumex_utils_modules, subdir: 'yumex/utils')
+
+yumex_service_modules = [
+  'service/__init__.py',
+  'service/dnf4.py',
+  'service/dnf5.py',
+  'service/yumex_updater_systray.py',
+]
+PY_INSTALLDIR.install_sources(yumex_service_modules, subdir: 'yumex/service')
+
+# Install systemd service file
+install_data(
+  'service/yumex-updater-systray.service',
+  install_dir: '/usr/lib/systemd/user/'
+)
+
+# Install systemd preset file
+install_data(
+  'service/50-yumex-updater-systray.preset',
+  install_dir: '/usr/lib/systemd/user-preset/'
+)
+
+# Install service config
+install_data(
+  'service/yumex-service.conf',
+  install_dir: '/usr/share/yumex/'
+)
+
+# Create a symlink in bindir to service/yumex_updater_systray.py
+install_symlink(
+  'yumex_updater_systray',
+  install_dir: get_option('bindir'),
+  pointing_to: join_paths(PY_INSTALLDIR.get_install_dir(), 'yumex', 'service/yumex_updater_systray.py')
+)
diff --git a/yumex/service/50-yumex-updater-systray.preset b/yumex/service/50-yumex-updater-systray.preset
new file mode 100644
index 0000000..f33b37b
--- /dev/null
+++ b/yumex/service/50-yumex-updater-systray.preset
@@ -0,0 +1 @@
+enable yumex-updater-systray.service
diff --git a/yumex/service/__init__.py b/yumex/service/__init__.py
new file mode 100644
index 0000000..baa245f
--- /dev/null
+++ b/yumex/service/__init__.py
@@ -0,0 +1,14 @@
+# This program is free software: you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or
+# (at your option) any later version.
+#
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+#
+# You should have received a copy of the GNU General Public License
+# along with this program.  If not, see <http://www.gnu.org/licenses/>.
+#
+# Copyright (C) 2024 Tim Lauridsen
diff --git a/yumex/service/dnf4.py b/yumex/service/dnf4.py
new file mode 100644
index 0000000..0993927
--- /dev/null
+++ b/yumex/service/dnf4.py
@@ -0,0 +1,44 @@
+import dnf as dnf
+from typing import List, Set
+
+def UpdateChecker() -> List[dnf.package.Package]:
+    base = dnf.Base()
+    base.read_all_repos()
+
+    def metadata_refresh(base: dnf.Base) -> None:
+        for repo in base.repos.iter_enabled():
+            repo.metadata_expire = 0
+            repo.load()
+
+    def get_repo_priority(repo_name: str) -> int:
+        repo = base.repos.get(repo_name)
+        return repo.priority if repo else 99
+
+    def get_package_repos(package_name: str) -> List[str]:
+        repos: Set[str] = set()
+        query = base.sack.query().available().filter(name=package_name)
+        for pkg in query.run():
+            repos.add(pkg.reponame)
+        return list(repos)
+
+    base.fill_sack(load_system_repo=True)
+    q = base.sack.query()
+    updates = q.upgrades().run()
+
+    metadata_refresh(base)
+
+    latest_versions = {}
+    for pkg in updates:
+        repos = get_package_repos(pkg.name)
+        repo_priorities = [get_repo_priority(repo) for repo in repos]
+        lowest_priority = min(repo_priorities) if repo_priorities else 99
+        pkg_repo_priority = pkg.repo.priority
+
+        if pkg_repo_priority == lowest_priority:
+            if pkg.name in latest_versions:
+                if pkg.evr > latest_versions[pkg.name].evr:
+                    latest_versions[pkg.name] = pkg
+            else:
+                latest_versions[pkg.name] = pkg
+
+    return list(latest_versions.values())
diff --git a/yumex/service/dnf5.py b/yumex/service/dnf5.py
new file mode 100644
index 0000000..b1c6bf4
--- /dev/null
+++ b/yumex/service/dnf5.py
@@ -0,0 +1,58 @@
+import libdnf5 as dnf
+from libdnf5.rpm import PackageQuery, Package  # noqa: F401
+from libdnf5.repo import RepoQuery  # noqa: F401
+from libdnf5.common import QueryCmp_NEQ
+from typing import List
+
+def UpdateChecker() -> List[Package]:
+    base = dnf.base.Base()
+    cache_directory = base.get_config().get_cachedir_option().get_value()
+    base.get_config().get_system_cachedir_option().set(cache_directory)
+
+    base.load_config()
+    base.setup()
+
+    def reset_backend(base: dnf.base.Base) -> None:
+        base.repo_sack = base.get_repo_sack()
+        base.repo_sack.create_repos_from_system_configuration()
+        base.repo_sack.update_and_load_enabled_repos(True)
+
+    reset_backend(base)
+
+    def get_repo_priority(base: dnf.base.Base, repo_name: str) -> int:
+        repos_query = RepoQuery(base)
+        for repo in repos_query:
+            if repo.get_id() == repo_name:
+                return repo.get_priority()
+        return 99
+
+    def get_package_repos(base: dnf.base.Base, package_name: str) -> List[str]:
+        repos = set()
+        query = PackageQuery(base)
+        query.filter_name([package_name])
+        for pkg in query:
+            repos.add(pkg.get_repo_id())
+        return list(repos)
+
+    updates = PackageQuery(base)
+    updates.filter_upgrades()
+    updates.filter_arch(["src"], QueryCmp_NEQ)
+    updates.filter_latest_evr()
+
+    updates_list = list(updates)
+
+    latest_versions = {}
+    for pkg in updates_list:
+        repos = get_package_repos(base, pkg.get_name())
+        repo_priorities = [get_repo_priority(base, repo) for repo in repos]
+        lowest_priority = min(repo_priorities) if repo_priorities else 99
+        pkg_repo_priority = get_repo_priority(base, pkg.get_repo_id())
+
+        if pkg_repo_priority == lowest_priority:
+            if pkg.get_name() in latest_versions:
+                if pkg.get_evr() > latest_versions[pkg.get_name()].get_evr():
+                    latest_versions[pkg.get_name()] = pkg
+            else:
+                latest_versions[pkg.get_name()] = pkg
+
+    return list(latest_versions.values())
diff --git a/yumex/service/yumex-service.conf b/yumex/service/yumex-service.conf
new file mode 100644
index 0000000..f4eaa51
--- /dev/null
+++ b/yumex/service/yumex-service.conf
@@ -0,0 +1,4 @@
+[DEFAULT]
+custom_updater=
+always_hide=false
+update_sync_interval=3600
diff --git a/yumex/service/yumex-updater-systray.service b/yumex/service/yumex-updater-systray.service
new file mode 100644
index 0000000..aeedc97
--- /dev/null
+++ b/yumex/service/yumex-updater-systray.service
@@ -0,0 +1,14 @@
+[Unit]
+Description=Service to monitor and manage system updates.
+After=graphical-session.target
+
+[Service]
+Type=simple
+ExecStart=/usr/bin/yumex_updater_systray
+RestartSec=5
+Restart=on-failure
+Environment=DISPLAY=:0
+Environment=XAUTHORITY=%h/.Xauthority
+
+[Install]
+WantedBy=default.target
diff --git a/yumex/service/yumex_updater_systray.py b/yumex/service/yumex_updater_systray.py
new file mode 100755
index 0000000..c932e85
--- /dev/null
+++ b/yumex/service/yumex_updater_systray.py
@@ -0,0 +1,145 @@
+#!/usr/bin/python3
+
+import gi
+gi.require_version('Gtk', '3.0')
+gi.require_version('AppIndicator3', '0.1')
+gi.require_version('GLib', '2.0')
+gi.require_version('Flatpak', '1.0')
+from gi.repository import Gtk, AppIndicator3, GLib, Flatpak
+import subprocess
+from pathlib import Path
+import cairosvg
+import io
+import os
+import shutil
+from PIL import Image
+import threading
+import time
+import dbus
+import dbus.service
+import dbus.mainloop.glib
+import configparser
+
+from yumex.constants import BACKEND
+if BACKEND == "DNF5":
+    from yumex.service.dnf5 import UpdateChecker
+else:
+    from yumex.service.dnf4 import UpdateChecker
+
+from typing import List, Set
+from packaging import version
+
+# Define paths
+home_dir = Path.home()
+config_dir = home_dir / '.config' / 'yumex'
+default_config_path = '/usr/share/yumex/yumex-service.conf'
+user_config_path = config_dir / 'yumex-service.conf'
+
+# Create the config directory if it doesn't exist
+config_dir.mkdir(parents=True, exist_ok=True)
+
+# Copy the default config file if the user config file doesn't exist
+if not user_config_path.exists():
+    shutil.copy(default_config_path, user_config_path)
+
+# Read configuration file
+config = configparser.ConfigParser()
+config.read(user_config_path)
+
+custom_updater = config.get('DEFAULT', 'custom_updater', fallback=None)
+always_hide = config.getboolean('DEFAULT', 'always_hide', fallback=False)
+update_sync_interval = config.getint('DEFAULT', 'update_sync_interval', fallback=3600)
+
+class UpdateService(dbus.service.Object):
+    def __init__(self, bus_name: dbus.service.BusName, object_path: str) -> None:
+        super().__init__(bus_name, object_path)
+
+    @dbus.service.method('com.yumex.UpdateService')
+    def RefreshUpdates(self) -> None:
+        refresh_updates()
+
+def on_clicked_update(widget: Gtk.Widget) -> None:
+    if custom_updater:
+        subprocess.Popen([custom_updater])
+
+def on_clicked_pm(widget: Gtk.Widget) -> None:
+    subprocess.Popen(["/usr/bin/yumex"])
+
+
+def refresh_updates(widget: Gtk.Widget = None) -> None:
+
+    sys_update_count = len(UpdateChecker())
+
+    flatpak_user_count = len(Flatpak.Installation.new_user().list_installed_refs_for_update())
+    flatpak_sys_count = len(Flatpak.Installation.new_system().list_installed_refs_for_update())
+
+    update_count = sys_update_count + flatpak_user_count + flatpak_sys_count
+
+    hover_text_lines = ["There are updates available:"]
+    if sys_update_count > 0:
+        hover_text_lines.append(f"  System: {sys_update_count}")
+    if flatpak_user_count > 0:
+        hover_text_lines.append(f"  Flatpak (user): {flatpak_user_count}")
+    if flatpak_sys_count > 0:
+        hover_text_lines.append(f"  Flatpak (system): {flatpak_sys_count}")
+    hover_text = "\n".join(hover_text_lines)
+
+    if not always_hide:
+        if update_count > 0:
+            GLib.idle_add(indicator.set_title, hover_text)
+            GLib.idle_add(indicator.set_status, AppIndicator3.IndicatorStatus.ACTIVE)
+        else:
+            GLib.idle_add(indicator.set_status, AppIndicator3.IndicatorStatus.PASSIVE)
+
+def check_updates() -> None:
+    while True:
+        refresh_updates()
+        time.sleep(update_sync_interval)
+
+
+svg_path = Path("/usr/share/icons/hicolor/scalable/apps/yumex-system-software-update.svg")
+png_data = cairosvg.svg2png(url=str(svg_path))
+
+image = Image.open(io.BytesIO(png_data))
+cache_dir = os.path.expanduser("~/.cache")
+image_path = os.path.join(cache_dir, "yumex-system-software-update.png")
+image.save(image_path)
+
+indicator = AppIndicator3.Indicator.new(
+    "test_icon",
+    image_path,
+    AppIndicator3.IndicatorCategory.APPLICATION_STATUS
+)
+indicator.set_status(AppIndicator3.IndicatorStatus.ACTIVE)
+indicator.set_title("Checking for updates...")
+
+menu = Gtk.Menu()
+
+refresh_item = Gtk.MenuItem(label="Check for Updates")
+refresh_item.connect("activate", refresh_updates)
+menu.append(refresh_item)
+
+if custom_updater:
+    update_item = Gtk.MenuItem(label="Update System")
+    update_item.connect("activate", on_clicked_update)
+    menu.append(update_item)
+
+pm_item = Gtk.MenuItem(label="Open Package Manager")
+pm_item.connect("activate", on_clicked_pm)
+menu.append(pm_item)
+
+menu.show_all()
+
+indicator.set_menu(menu)
+
+dbus.mainloop.glib.DBusGMainLoop(set_as_default=True)
+session_bus = dbus.SessionBus()
+bus_name = dbus.service.BusName('com.yumex.UpdateService', session_bus)
+update_service = UpdateService(bus_name, '/com/yumex/UpdateService')
+
+refresh_updates()
+
+update_thread = threading.Thread(target=check_updates, daemon=True)
+update_thread.start()
+
+Gtk.main()
diff --git a/yumex/ui/flatpak_result.py b/yumex/ui/flatpak_result.py
index 1c0df1e..8484b80 100644
--- a/yumex/ui/flatpak_result.py
+++ b/yumex/ui/flatpak_result.py
@@ -35,7 +35,7 @@ class ResultElem(GObject.GObject):
             case FlatpakAction.UNINSTALL:
                 action_str = _("Uninstalling")
             case _:
-                action_str = _("Updateing")
+                action_str = _("Updating")
         return f"{action_str} : <i>{self.location.upper()}</i>  - <b>{self.ref}</b> <small>({self.source})</small> "  # noqa
 
 
diff --git a/yumex/ui/flatpak_view.py b/yumex/ui/flatpak_view.py
index 25fbb69..1c8b695 100644
--- a/yumex/ui/flatpak_view.py
+++ b/yumex/ui/flatpak_view.py
@@ -28,6 +28,7 @@ from yumex.constants import ROOTDIR
 from yumex.ui.flatpak_search import YumexFlatpakSearch
 from yumex.utils import RunJob, log
 from yumex.utils.enums import FlatpakLocation, FlatpakType, Page
+from yumex.utils.dbus import sync_updates
 
 
 @Gtk.Template(resource_path=f"{ROOTDIR}/ui/flatpak_view.ui")
@@ -80,19 +81,23 @@ class YumexFlatpakView(Gtk.ListView):
         """update all flatpaks with pending updates"""
 
         if self.do_transaction(self.backend.do_update_all):
-            self.presenter.show_message(_("flatpaks was updated"), timeout=2)
+            self.presenter.show_message(_("flatpaks were updated"), timeout=2)
+            sync_updates()
 
     def remove_unused(self) -> None:
         """remove all unused flatpaks (runtimes etc)"""
 
         if self.do_transaction(self.backend.do_remove_unused):
-            self.presenter.show_message(_("Unused flatpaks was removed"), timeout=2)
+            self.presenter.show_message(_("Unused flatpaks were removed"), timeout=2)
+            sync_updates()
 
     def update(self, pkg) -> None:
         """update a flatpak"""
 
         if self.do_transaction(self.backend.do_update, [pkg]):
-            self.presenter.show_message(_(f"{pkg.id} is now removed"), timeout=2)
+            self.presenter.show_message(_(f"{pkg.id} is now updated"), timeout=2)
+            sync_updates()
+
 
     def search(self):
         self.presenter.select_page(Page.FLATPAKS)
@@ -112,9 +117,10 @@ class YumexFlatpakView(Gtk.ListView):
                     if flatpak_search.confirm:
                         if self.do_transaction(self.backend.do_install, ref, remote, location):
                             self.presenter.show_message(_(f"{fp_id} is now installed"), timeout=2)
+                            sync_updates()
 
                 else:
-                    self.presenter.show_message(f"{fp_id} is not found om {remote}")
+                    self.presenter.show_message(f"{fp_id} is not found on {remote}")
 
     def install(self, *args) -> None:
         """install a new flatpak"""
@@ -137,15 +143,17 @@ class YumexFlatpakView(Gtk.ListView):
                 if flatpak_installer.confirm:
                     if self.do_transaction(self.backend.do_install, ref, remote, location):
                         self.presenter.show_message(_(f"{fp_id} is now installed"), timeout=2)
+                        sync_updates()
 
             else:
-                self.presenter.show_message(f"{fp_id} is not found om {remote}")
+                self.presenter.show_message(f"{fp_id} is not found on {remote}")
 
     def remove(self, pkg=None) -> None:
         """remove an flatpak"""
         selected = [pkg] if pkg else [self.selection.get_selected_item()]
         if self.do_transaction(self.backend.do_remove, selected):
             self.presenter.show_message(_(f"{selected[0].id} is now removed"), timeout=2)
+            sync_updates()
 
     def show_runtime(self):
         log("Show Runtime")
diff --git a/yumex/ui/window.py b/yumex/ui/window.py
index c6ae5f4..1d6874c 100644
--- a/yumex/ui/window.py
+++ b/yumex/ui/window.py
@@ -32,6 +32,7 @@ from yumex.ui.package_info import YumexPackageInfo
 from yumex.ui.transaction_result import YumexTransactionResult
 from yumex.utils import RunAsync, log
 from yumex.utils.enums import InfoType, PackageFilter, SearchField, Page, SortType
+from yumex.utils.dbus import sync_updates
 
 
 @Gtk.Template(resource_path=f"{ROOTDIR}/ui/window.ui")
@@ -273,7 +274,8 @@ class YumexMainWindow(Adw.ApplicationWindow):
             log(f"Execute the transaction on {len(queued)} packages")
             result = self._do_transaction(queued)
             log(f"Transaction execution ended : {result}")
-            if result:  # transaction completed without issues
+            if result:  # transaction completed without issues\
+                sync_updates()
                 self.show_message(_("Transaction completed succesfully"), timeout=3)
             # reset everything
             self.package_view.reset()
diff --git a/yumex/utils/dbus.py b/yumex/utils/dbus.py
new file mode 100644
index 0000000..d2fcce3
--- /dev/null
+++ b/yumex/utils/dbus.py
@@ -0,0 +1,39 @@
+import dbus
+from dbus.exceptions import DBusException
+
+def is_user_service_running(service_name):
+    try:
+        # Connect to the user bus
+        bus = dbus.SessionBus()
+        # Get the systemd service manager object
+        systemd = bus.get_object('org.freedesktop.systemd1', '/org/freedesktop/systemd1')
+        manager = dbus.Interface(systemd, 'org.freedesktop.systemd1.Manager')
+        # Get the unit status
+        unit_path = manager.GetUnit(service_name)
+        unit = bus.get_object('org.freedesktop.systemd1', unit_path)
+        unit_properties = dbus.Interface(unit, 'org.freedesktop.DBus.Properties')
+        # Check the SubState of the service
+        sub_state = unit_properties.Get('org.freedesktop.systemd1.Unit', 'SubState')
+        return sub_state == 'running'
+    except DBusException as e:
+        print(f"Error checking service status: {e}")
+        return False
+
+def sync_updates():
+    service_name = 'yumex-updater-systray.service'
+
+    if is_user_service_running(service_name):
+        try:
+            # Connect to the session bus
+            bus = dbus.SessionBus()
+            # Get the object
+            tray_icon_object = bus.get_object('com.yumex.UpdateService', '/com/yumex/UpdateService')
+            # Get the interface
+            tray_icon_interface = dbus.Interface(tray_icon_object, 'com.yumex.UpdateService')
+            # Call the RefreshUpdates method
+            tray_icon_interface.RefreshUpdates()
+        except DBusException as e:
+            print(f"DBusException: {e}")
+            # Handle the exception or log it as needed
+    else:
+        print(f"The service {service_name} is not running.")
-- 
2.45.1

